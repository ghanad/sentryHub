{% extends "dashboard/base.html" %}
{% load static core_tags %}

{% block title %}Slack Admin - SentryHub{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'dashboard/css/modern_dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'integrations/css/slack-admin.css' %}">
{% endblock %}

{% block main_content %}
    <header class="page-header">
        <h1 class="page-title">Slack Integration Admin</h1>
    </header>

    {% include 'core/partials/_messages.html' %}

    <div class="row">
        <!-- Simple Test Message -->
        <div class="col-lg-6">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h5 class="chart-title d-flex align-items-center gap-2">
                        <i class='bx bxl-slack'></i>
                        Send Test Message
                    </h5>
                </div>
                <div class="chart-card-body">
                    <p>Use the form below to send a simple test message to a Slack channel using the configured proxy endpoint.</p>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="send_simple" value="1">
                        <div class="mb-3">
                            {{ form.channel.label_tag }}
                            {{ form.channel }}
                        </div>
                        <div class="mb-3">
                            {{ form.message.label_tag }}
                            {{ form.message }}
                        </div>
                        <button type="submit" class="btn btn-primary d-flex align-items-center gap-1">
                            <i class='bx bx-paper-plane'></i> Send Message
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Template Test (Preview & Send) -->
        <div class="col-lg-6">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h5 class="chart-title d-flex align-items-center gap-2">
                        <i class='bx bx-code-block'></i>
                        Template Test (Preview & Send)
                    </h5>
                </div>
                <div class="chart-card-body">
                    <p>Use Django template syntax like <code>{% verbatim %}{{ alertname }}{% endverbatim %}</code>, <code>{% verbatim %}{{ labels.instance }}{% endverbatim %}</code>, <code>{% verbatim %}{{ annotations.summary }}{% endverbatim %}</code>. You can also add custom keys via Extra Context.</p>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="preview_template" value="1">
                        {% if template_form %}
                            <div class="mb-3">
                                {{ template_form.channel.label_tag }}
                                {{ template_form.channel }}
                            </div>
                            <div class="mb-3">
                                {{ template_form.message_template.label_tag }}
                                {{ template_form.message_template }}
                            </div>
                            <div class="mb-3">
                                {{ template_form.extra_context.label_tag }}
                                {{ template_form.extra_context }}
                                {% if template_form.extra_context.help_text %}
                                    <div class="form-text">{{ template_form.extra_context.help_text }}</div>
                                {% endif %}
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-secondary">
                                    <i class='bx bx-show'></i> Preview
                                </button>
                                <button type="submit" name="send_template" value="1" class="btn btn-primary">
                                    <i class='bx bx-send'></i> Send Rendered
                                </button>
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                Template test form is not available.
                            </div>
                        {% endif %}
                    </form>

                    {% if rendered_preview is not None %}
                        <hr>
                        <h6 class="mb-2">Rendered Preview</h6>
                        <div class="bg-light p-3 border rounded" style="white-space: pre-wrap; font-family: var(--bs-font-monospace, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace);">
                            {{ rendered_preview|safe }}
                        </div>
                        <div class="form-text mt-2">
                            Note: Slack shortcodes like :fire: are shown literally in preview but will render as emojis inside Slack. Unicode emojis (e.g. ðŸ”¥) appear here as-is.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
{% endblock %}
