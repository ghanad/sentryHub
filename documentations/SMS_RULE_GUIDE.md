# ุฑุงูููุง ุชูุธู ููุงูู ฺฉูพุงุฑฺูโุณุงุฒ ูพุงูฺฉ (SMS) ุฏุฑ SentryHub

## ููุฏูู

ุงู ุตูุญู ุฑุงูููุง ุจู ุดูุง ุฏุฑ ุงุฌุงุฏ ู ูุฏุฑุช "SMS Integration Rules" ุฏุฑ SentryHub ฺฉูฺฉ ูโฺฉูุฏ. ุงู ููุงูู ุจู ุดูุง ุงุฌุงุฒู ูโุฏููุฏ ุชุง ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุจุฑ ุงุณุงุณ ูุดุฏุงุฑูุง ุฏุฑุงูุช ุงุฒ Alertmanagerุ ูพุงูฺฉโูุง ุฑุง ุจู ุดูุงุฑูโูุง ุงุฒ ูพุด ุชุนุฑูโุดุฏู ุงุฑุณุงู ฺฉูุฏ. ุชูุธู ุตุญุญ ุงู ููุงูู ูโุชูุงูุฏ ุจู ุทูุฑ ูุงุจู ุชูุฌู ูุฑุขูุฏ ุงุทูุงุนโุฑุณุงู ู ูพุงุณุฎ ุจู ุญูุงุฏุซ ุฑุง ุจูุจูุฏ ุจุฎุดุฏ.

## ูุฏู ููุงูู

ูุฏู ุงุตู ุงู ููุงููุ ุชุนุฑู **ุดุฑุงุท** ุงุณุช ฺฉู ุชุญุช ุขู ฺฉ ูุดุฏุงุฑ ุฎุงุต ุจุงุฏ ููุฌุฑ ุจู **ุงุฑุณุงู ูพุงูฺฉ** ุจู ฺฉ ุง ฺูุฏ ฺฏุฑูุฏู ูุดุฎุต ุดูุฏ.

## ุงุฌุงุฏ/ูุฑุงุด ฺฉ ูุงููู

ุจุฑุง ุงุฌุงุฏ ุง ูุฑุงุด ูุงูููุ ุจู ุจุฎุด "Integrations" -> "SMS Rules" ุฏุฑ ููู SentryHub ุจุฑูุฏ. ูุฑู ุดุงูู ุจุฎุดโูุง ุฒุฑ ุงุณุช:

### ฑ. ุชูุธูุงุช ุนููู (General Settings)

*   **Name:** ฺฉ ูุงู ููุญุตุฑ ุจู ูุฑุฏ ู ุชูุตู ุจุฑุง ูุงููู ุฎูุฏ ุงูุชุฎุงุจ ฺฉูุฏ (ูุซูุงู `Send Critical SMS for DB Alerts`, `SMS for Resolved Infra Issues`).
*   **Is Active:** ุงู ฺฺฉโุจุงฺฉุณ ูุดุฎุต ูโฺฉูุฏ ฺฉู ุขุง ูุงููู ูุนุงู ุงุณุช ู ุจุงุฏ ุจุฑุง ูุดุฏุงุฑูุง ูุฑูุฏ ุงุนูุงู ุดูุฏ ุง ุฎุฑ. ููุงูู ุบุฑูุนุงู ูุงุฏุฏู ฺฏุฑูุชู ูโุดููุฏ.
*   **Priority:** ฺฉ ุนุฏุฏ ุตุญุญ ฺฉู ุงูููุช ุงู ูุงููู ุฑุง ูุณุจุช ุจู ุณุงุฑ ููุงูู ูุดุฎุต ูโฺฉูุฏ. **ุนุฏุฏ ุจุงูุงุชุฑ ุจู ูุนูุง ุงูููุช ุจุดุชุฑ ุงุณุช.** ุฒูุงู ฺฉู ฺฉ ูุดุฏุงุฑ ุจุง ูุนุงุฑูุง ฺูุฏ ูุงููู ูุทุงุจูุช ุฏุงุฑุฏุ ูุงููู ุจุง ุจุงูุงุชุฑู ุงูููุช ุงูุชุฎุงุจ ูโุดูุฏ (ุฌุฒุฆุงุช ุจุดุชุฑ ุฏุฑ ุจุฎุด "ููุทู ุชุทุจู ููุงูู").

### ฒ. ุชูุธูุงุช ฺฏุฑูุฏฺฏุงู (Recipient Settings)

*   **Recipients:** ูุณุช ุงุฒ **ูุงูโูุง ฺฏุฑูุฏฺฏุงู** ฺฉู ุฏุฑ ุจุฎุด "PhoneBook" SentryHub ุชุนุฑู ุดุฏูโุงูุฏ. ูุงูโูุง ุฑุง ุจุง **ฺฉุงูุง (,)** ุงุฒ ูู ุฌุฏุง ฺฉูุฏ (ูุซูุงู `admin,oncall_team,manager`). ูพุงูฺฉ ุจู ุดูุงุฑู ุชูููโูุง ูุฑุชุจุท ุจุง ุงู ูุงูโูุง ุงุฑุณุงู ุฎูุงูุฏ ุดุฏ.
*   **Use SMS Annotation:** ุงฺฏุฑ ุงู ฺฏุฒูู ูุนุงู ุจุงุดุฏุ SentryHub ุจู ุฌุง ุงุณุชูุงุฏู ุงุฒ ูุณุช `Recipients` ุชุนุฑูโุดุฏู ุฏุฑ ุงู ูุงูููุ ุณุน ูโฺฉูุฏ ฺฏุฑูุฏฺฏุงู ุฑุง ุงุฒ `annotations['sms']` ุขุฎุฑู `AlertInstance` ุงุณุชุฎุฑุงุฌ ฺฉูุฏ. ููุฏุงุฑ `annotations['sms']` ุจุงุฏ ฺฉ ุฑุดุชู ุจุง ูุงูโูุง ฺฏุฑูุฏฺฏุงู ุฌุฏุง ุดุฏู ุจุง ฺฉุงูุง ุจุงุดุฏ (ูุซูุงู `{"sms": "user1,user2"}`). ุงู ูุงุจูุช ุจุฑุง ุงุฑุณุงู ูพูุง ุจู ฺฏุฑูุฏฺฏุงู ูุฎุชูู ุจุฑ ุงุณุงุณ ูุญุชูุง ูุดุฏุงุฑ ููุฏ ุงุณุช.

### ณ. ูุนุงุฑูุง ุชุทุจู (Match Criteria)

ุงู ุจุฎุด **ูููโุชุฑู** ูุณูุช ุจุฑุง ุชุนู **ฺฉุฏุงู ูุดุฏุงุฑูุง** ุจุงุฏ ุงู ูุงููู ุฑุง ูุนุงู ฺฉููุฏ.

*   **ูุฑูุช:** ุจุงุฏ ฺฉ **ุขุจุฌฺฉุช JSON ูุนุชุจุฑ** ุจุงุดุฏ (ุจุง `{}` ุดุฑูุน ู ุชูุงู ุดูุฏ).
*   **ููุทู:** ุชุทุงุจู **ุฏูู** ุงูุฌุงู ูโุดูุฏ. ุชูุงู ุฌูุชโูุง **ฺฉูุฏ: ููุฏุงุฑ** ฺฉู ุฏุฑ ุงู JSON ุชุนุฑู ูโฺฉูุฏุ **ุจุงุฏ** ุฏููุงู ุจุง ููุงู ฺฉูุฏ ู ููุฏุงุฑ ุฏุฑ ุจุฎุด `labels` ูุดุฏุงุฑ ุฏุฑุงูุช ูุฌูุฏ ุฏุงุดุชู ุจุงุดูุฏ ุชุง ูุงููู ูุทุงุจูุช ูพุฏุง ฺฉูุฏ.
*   **ูุซุงูโูุง:**
    *   `{"severity": "critical"}`: ููุท ูุดุฏุงุฑูุง ฺฉู ุฏุงุฑุง ูุจู `severity` ุจุง ููุฏุงุฑ ุฏูู `critical` ูุณุชูุฏุ ูุทุงุจูุช ูพุฏุง ูโฺฉููุฏ.
    *   `{"job": "node_exporter", "instance": "server1.example.com"}`: ููุท ูุดุฏุงุฑูุง ฺฉู **ูู** ูุจู `job` ุจุง ููุฏุงุฑ `node_exporter` ู **ูู** ูุจู `instance` ุจุง ููุฏุงุฑ `server1.example.com` ุฏุงุฑูุฏุ ูุทุงุจูุช ูพุฏุง ูโฺฉููุฏ.
    *   `{}`: (ุชูุตู ููโุดูุฏ) ฺฉ ุขุจุฌฺฉุช ุฎุงู ุจุง ุชูุงู ูุดุฏุงุฑูุง ูุทุงุจูุช ูพุฏุง ูโฺฉูุฏุ ุงูุง ุจู ุฏูู ุนุฏู ูุฌูุฏ ูุนุงุฑ ุฎุงุตุ ุงุญุชูุงูุงู ุชูุณุท ููุงูู ุจุง ุงูููุช ุจุงูุงุชุฑ ุง ูุนุงุฑูุง ุจุดุชุฑ ูุงุฏุฏู ฺฏุฑูุชู ูโุดูุฏ (ุจู ุจุฎุด "ููุทู ุชุทุจู ููุงูู" ูุฑุงุฌุนู ฺฉูุฏ). ุจูุชุฑ ุงุณุช ููุดู ูุนุงุฑูุง ูุดุฎุต ุชุนุฑู ฺฉูุฏ.

### ด. ูุงูุจโูุง ูพุงูฺฉ (SMS Templates)

ุงู ุจุฎุดโูุง ูุญุชูุง ูพุงูฺฉ ฺฉู ุงุฑุณุงู ูโุดูุฏ ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ **ุฒุจุงู ูุงูุจ ุฌูฺฏู (Django Template Language - DTL)** ุชุนุฑู ูโฺฉููุฏ. ุดูุง ูโุชูุงูุฏ ุงุฒ ูุชุบุฑูุง ูุฑุจูุท ุจู ูุดุฏุงุฑ ุฏุฑ ุงู ูุงูุจโูุง ุงุณุชูุงุฏู ฺฉูุฏ.

*   **Firing Template:** ูุงูุจ ุจุฑุง ูุชู ูพุงูฺฉ ฺฉู ููฺฏุงู ูุนุงู ุดุฏู (Firing) ูุดุฏุงุฑ ุงุฑุณุงู ูโุดูุฏ.
    *   ูุซุงู: `Alert: {{ alertname }} on {{ labels.instance }} is {{ alert_group.current_status|upper }}. Severity: {{ severity }}`
*   **Resolved Template:** (ุงุฎุชุงุฑ) ูุงูุจ ุจุฑุง ูุชู ูพุงูฺฉ ฺฉู ููฺฏุงู ุฑูุน ุดุฏู (Resolved) ูุดุฏุงุฑ ุงุฑุณุงู ูโุดูุฏ. ุงฺฏุฑ ุงู ููุฏ ุฎุงู ุจูุงูุฏุ ูฺ ูพุงูฺฉ ุจุฑุง ูุถุนุช Resolved ุงุฑุณุงู ูุฎูุงูุฏ ุดุฏ.
    *   ูุซุงู: `Alert: {{ alertname }} on {{ labels.instance }} is now RESOLVED.`

### ต. ูุชุบุฑูุง ูุงุจู ุงุณุชูุงุฏู ุฏุฑ ูุงูุจโูุง (Available Template Variables)

ููฺฏุงู ุฑูุฏุฑ ฺฉุฑุฏู ูุงูุจโูุง ูพุงูฺฉุ ูุชุบุฑูุง ุฒุฑ ุฏุฑ ุฏุณุชุฑุณ ูุณุชูุฏ:

*   `{{ alert_group }}`: ุขุจุฌฺฉุช ูุฏู `AlertGroup` ุฌูฺฏู. ูโุชูุงูุฏ ุจู ููุฏูุง ุขู ุฏุณุชุฑุณ ูพุฏุง ฺฉูุฏ:
    *   `{{ alert_group.name }}`
    *   `{{ alert_group.fingerprint }}`
    *   `{{ alert_group.labels }}` (ุฏฺฉุดูุฑ ูุจูโูุง)
    *   `{{ alert_group.severity }}`
    *   `{{ alert_group.instance }}`
    *   `{{ alert_group.first_occurrence }}` (ุขุจุฌฺฉุช datetime)
    *   `{{ alert_group.last_occurrence }}` (ุขุจุฌฺฉุช datetime)
    *   `{{ alert_group.current_status }}` (ูุซูุงู `firing` ุง `resolved`)
    *   ...
*   `{{ latest_instance }}`: ุขุจุฌฺฉุช ูุฏู `AlertInstance` ูุฑุจูุท ุจู ุขุฎุฑู ูุถุนุช ูุดุฏุงุฑ (ููฺฉู ุงุณุช `None` ุจุงุดุฏ). ูโุชูุงูุฏ ุจู ููุฏูุง ุขู ุฏุณุชุฑุณ ูพุฏุง ฺฉูุฏ:
    *   `{{ latest_instance.started_at }}` (ุขุจุฌฺฉุช datetime)
    *   `{{ latest_instance.ended_at }}` (ุขุจุฌฺฉุช datetime ุง `None`)
    *   `{{ latest_instance.annotations }}` (ุฏฺฉุดูุฑ)
    *   ...
*   `{{ annotations }}`: ุฏฺฉุดูุฑ ฺฉุงูู `annotations` ูุฑุจูุท ุจู **ุขุฎุฑู** `AlertInstance` ูุดุฏุงุฑ (ูุงูุจุฑ ุจุฑุง `latest_instance.annotations`).
*   `{{ labels }}`: ุฏฺฉุดูุฑ ฺฉุงูู `labels` ูุฑุจูุท ุจู ูุดุฏุงุฑ (ูุงูุจุฑ ุจุฑุง `alert_group.labels`).
*   `{{ alertname }}`: ููุฏุงุฑ ูุจู `alertname` (ูุงูุจุฑ ุจุฑุง `labels.alertname`).
*   `{{ fingerprint }}`: ููุฏุงุฑ `fingerprint` ูุดุฏุงุฑ (ููุงู `alert_group.fingerprint`).
*   `{{ severity }}`: ููุฏุงุฑ ูุจู `severity` (ูุซูุงู `Critical`, `Warning`).
*   `{{ now }}`: ุขุจุฌฺฉุช datetime ุฒูุงู ุงุฌุฑุง ุชุณฺฉ.

### ถ. ุงุณุชูุงุฏู ุงุฒ ููุทู ุฏุฑ ูุงูุจโูุง (Using Template Logic)

ูโุชูุงูุฏ ุงุฒ ุชฺฏโูุง ุงุณุชุงูุฏุงุฑุฏ Django Template Language ุงุณุชูุงุฏู ฺฉูุฏ:

*   **ุดุฑุทโูุง (If/Else):**

    ```django
{% if labels.severity == 'critical' %}
  CRITICAL ALERT!
{% elif labels.severity == 'warning' %}
  Warning
{% else %}
  Info
{% endif %}

{% if alert_group.current_status == 'resolved' %}
  Alert has been resolved.
{% endif %}
    ```

*   **ุญูููโูุง (For Loops):**
    ```django
All Labels:
{% for key, value in labels.items() %}
  - {{ key }}: {{ value }}
{% empty %}
  No labels found.
{% endfor %}
    ```

*   **ููุชุฑูุง (Filters):**
    *   `|title`: `{{ alert_group.current_status|title }}` -> `Firing` ุง `Resolved`
    *   `|upper`: `{{ labels.dc|upper }}`
    *   `|default:"-"`: `{{ labels.optional_label|default:"N/A" }}`
    *   `|date:"Y-m-d H:i"`: `{{ latest_instance.started_at|date:"Y-m-d H:i" }}` (ุจุฑุง ุขุจุฌฺฉุชโูุง datetime)

## ููุทู ุชุทุจู ููุงูู (Rule Matching Logic)

ุฒูุงู ฺฉู ฺฉ ูุดุฏุงุฑ ุฏุฑุงูุช ูโุดูุฏ ู ูุงุฒ ุจู ุจุฑุฑุณ ููุงูู SMS ุฏุงุฑุฏ (ุนู `firing` ุงุณุช ู `silenced` ูุณุชุ ุง `resolved` ุงุณุช)ุ SentryHub ุจู ุชุฑุชุจ ุฒุฑ ุจูุชุฑู ูุงููู ูุทุงุจู ุฑุง ูพุฏุง ูโฺฉูุฏ:

1.  **ููุชุฑ ุงููู:** ููุท ููุงูู `is_active=True` ุฏุฑ ูุธุฑ ฺฏุฑูุชู ูโุดููุฏ.
2.  **ุชุทุงุจู ูุนุงุฑูุง:** ุชูุงู ููุงูู ฺฉู `match_criteria` ุขูโูุง **ุจู ุทูุฑ ฺฉุงูู** ุชูุณุท `labels` ูุดุฏุงุฑ ุจุฑุขูุฑุฏู ูโุดูุฏุ ูพุฏุง ูโุดููุฏ.
3.  **ุงูุชุฎุงุจ ุฎุงุตโุชุฑู ูุงููู:** ุงุฒ ุจู ููุงูู ูุทุงุจูุ ูุงููู ุงูุชุฎุงุจ ูโุดูุฏ ฺฉู **ุจุดุชุฑู ุชุนุฏุงุฏ ฺฉูุฏ** ุฑุง ุฏุฑ `match_criteria` ุฎูุฏ ุฏุงุฑุฏ (ุนู ุฏููโุชุฑ ู ุฎุงุตโุชุฑ ุงุณุช).
4.  **ุงูููุช (Priority) ุจู ุนููุงู ฺฏุฑูโฺฏุดุง:** ุงฺฏุฑ ฺูุฏ ูุงููู ุจุง **ุชุนุฏุงุฏ ูุนุงุฑูุง ฺฉุณุงู** ูุทุงุจูุช ุฏุงุดุชู ุจุงุดูุฏุ ูุงููู ุจุง **ุจุงูุงุชุฑู ุนุฏุฏ** `priority` ุงูุชุฎุงุจ ูโุดูุฏ.
5.  **ูุงู ุจู ุนููุงู ฺฏุฑูโฺฏุดุง ููุง:** ุงฺฏุฑ ุงูููุชโูุง ูุฒ ฺฉุณุงู ุจุงุดูุฏุ ูุงููู ฺฉู ูุงู ุขู ุงุฒ ูุธุฑ ุงููุจุง **ุฒูุฏุชุฑ** ูโุขุฏุ ุงูุชุฎุงุจ ูโุดูุฏ.

**ููู:** ููุท **ฺฉ** ูุงููู (ุจูุชุฑู ุชุทุงุจู) ุจุฑุง ูุฑ ุฑูุฏุงุฏ ูุดุฏุงุฑ (firing ุง resolved) ุงุฌุฑุง ูโุดูุฏ.

## ูุซุงู ฺฉุงูู ฺฉ ูุงููู

*   **Name:** `Critical CPU SMS for Admins`
*   **Is Active:** `True`
*   **Priority:** `100`
*   **Recipients:** `admin,oncall_engineer`
*   **Use SMS Annotation:** `False`
*   **Match Criteria:**
    ```json
{
  "alertname": "HighCPUUsage",
  "severity": "critical",
  "environment": "production"
}
    ```

*   **Firing Template:**
    ```django
๐ฅ CRITICAL ALERT: {{ alertname }} on {{ labels.instance }} ({{ severity|upper }}).
Details: {{ annotations.summary|default:"N/A" }}.
Check SentryHub: {{ sentryhub_url }}
    ```

*   **Resolved Template:**
    ```django
โ RESOLVED: {{ alertname }} on {{ labels.instance }}.
Issue cleared.
    ```

## ูุดฺฉูุงุช ุฑุงุฌ

*   **TemplateSyntaxError:** ุณูุชฺฉุณ ูุงูุจ ุฑุง ุจุฑุฑุณ ฺฉูุฏ.
*   **JSON ูุงูุนุชุจุฑ ุฏุฑ Match Criteria:** ุณุงุฎุชุงุฑ JSON ุฑุง ุงุนุชุจุงุฑุณูุฌ ฺฉูุฏ.
*   **ฺฏุฑูุฏู ุงูุช ูุดุฏ:** ุงุทููุงู ุญุงุตู ฺฉูุฏ ฺฉู ูุงูโูุง ฺฏุฑูุฏู ุฏุฑ `PhoneBook` ุชุนุฑู ุดุฏูโุงูุฏ ู ุงููุง ุขูโูุง ุตุญุญ ุงุณุช.
*   **ุงุฑุณุงู ูพุงูฺฉ ูุงูููู:** ุชูุธูุงุช ุงุฑุงุฆูโุฏููุฏู ูพุงูฺฉ ุฏุฑ `settings.py` (ูุงููุฏ `SMS_PROVIDER_SEND_URL`, `USERNAME`, `PASSWORD`, `DOMAIN`, `SENDER`) ุฑุง ุจุฑุฑุณ ฺฉูุฏ ู ูุงฺฏโูุง ุณุณุชู ุฑุง ุจุจูุฏ.